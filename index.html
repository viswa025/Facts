<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .news-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .news-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .nav-link {
            transition: all 0.2s ease-in-out;
            border-bottom: 2px solid transparent;
        }
        .nav-link.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }
        .nav-link:hover {
            color: #4f46e5;
        }
        #chatbot-container { position: fixed; bottom: 2rem; right: 2rem; z-index: 1000; }
        #chatbot-toggle { background-color: #4f46e5; color: white; width: 4rem; height: 4rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.2), 0 4px 6px -4px rgb(0 0 0 / 0.1); cursor: pointer; transition: transform 0.2s; }
        #chatbot-toggle:hover { transform: scale(1.1); }
        #chatbot-window { position: absolute; bottom: 5.5rem; right: 0; width: 24rem; height: 32rem; background-color: white; border-radius: 0.75rem; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); display: flex; flex-direction: column; overflow: hidden; transform-origin: bottom right; transition: transform 0.3s ease-out, opacity 0.3s ease-out; }
        .chat-message { padding: 0.75rem 1rem; border-radius: 0.75rem; max-width: 80%; word-wrap: break-word; }
        .user-message { background-color: #4f46e5; color: white; align-self: flex-end; }
        .bot-message { background-color: #e5e7eb; color: #1f2937; align-self: flex-start; }
        #chat-messages::-webkit-scrollbar { display: none; }
        #chat-messages { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="antialiased">

    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex justify-between items-center">
                    <h1 class="text-3xl font-bold text-gray-900">
                        <span class="text-indigo-600">Facts</span>
                    </h1>
                    <nav class="hidden md:flex space-x-8">
                        <a href="#" class="nav-link text-lg font-medium text-gray-600 active" data-category="national">National</a>
                        <a href="#" class="nav-link text-lg font-medium text-gray-600" data-category="international">International</a>
                    </nav>
                </div>
                <nav class="md:hidden mt-4">
                    <div class="flex justify-around">
                        <a href="#" class="nav-link text-md font-medium text-gray-600 active" data-category="national">National</a>
                        <a href="#" class="nav-link text-md font-medium text-gray-600" data-category="international">International</a>
                    </div>
                </nav>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div id="news-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
            <div id="loader" class="text-center py-16 hidden">
                <svg class="animate-spin h-10 w-10 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-lg text-gray-600">Fetching live news for you...</p>
            </div>
        </main>
    </div>

    <!-- Chatbot -->
    <div id="chatbot-container">
        <div id="chatbot-window" class="hidden scale-0 opacity-0">
            <div class="flex-shrink-0 p-4 bg-indigo-600 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg">News Assistant</h3>
                <button id="close-chatbot" class="text-white hover:text-indigo-200">&times;</button>
            </div>
            <div id="chat-messages" class="flex-1 p-4 space-y-4 overflow-y-auto"></div>
            <div class="flex-shrink-0 p-3 border-t bg-gray-50">
                <div class="flex items-center space-x-2">
                    <input type="text" id="chat-input" placeholder="Ask about the news..." class="w-full px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button id="chat-send" class="bg-indigo-600 text-white p-2 rounded-full hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    </button>
                </div>
            </div>
        </div>
        <button id="chatbot-toggle">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
        </button>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            const newsContainer = document.getElementById('news-container');
            const loader = document.getElementById('loader');
            const navLinks = document.querySelectorAll('.nav-link');
            
            // Chatbot UI elements
            const chatbotToggle = document.getElementById('chatbot-toggle');
            const chatbotWindow = document.getElementById('chatbot-window');
            const closeChatbot = document.getElementById('close-chatbot');
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const chatSend = document.getElementById('chat-send');

            let currentNewsHeadlines = [];
            let currentCategory = 'national';
            
            // Firebase state
            let db, auth, userId, isAuthReady = false;

            // --- Firebase Initialization ---
            async function initFirebase() {
                try {
                    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    
                    if (!firebaseConfig.apiKey) {
                        console.error("Firebase config is missing.");
                        return;
                    }

                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    // setLogLevel('debug');

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            isAuthReady = true;
                            console.log("Authenticated User ID:", userId);
                            setupChatListener(); 
                        }
                    });

                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Initialization Error:", error);
                }
            }

            // --- News Fetching and Display ---
            const fetchNews = async (category) => {
                loader.classList.remove('hidden');
                newsContainer.innerHTML = '';
                currentNewsHeadlines = [];

                try {
                    const articles = await fetchBbcNews(category);
                    currentNewsHeadlines = articles.map(a => a.title);

                    if (!articles || articles.length === 0) {
                        newsContainer.innerHTML = '<p class="text-center text-gray-500 col-span-full">Could not fetch live news. Please try again later.</p>';
                    } else {
                        articles.forEach(article => {
                            const card = document.createElement('div');
                            card.className = 'news-card p-6';
                            card.innerHTML = `<h2 class="text-xl font-bold text-gray-800 mb-2">${article.title}</h2><p class="text-gray-600">${article.summary}</p>`;
                            newsContainer.appendChild(card);
                        });
                    }
                } catch (error) {
                    console.error("Error fetching news:", error);
                    newsContainer.innerHTML = '<p class="text-center text-red-500 col-span-full">An error occurred while fetching news.</p>';
                } finally {
                    loader.classList.add('hidden');
                }
            };

            async function fetchBbcNews(category, retries = 3, delay = 1000) {
                let bbcUrl = 'https://bbc-news-api.vercel.app/';
                bbcUrl += category === 'national' ? 'latest?lang=english' : 'news?lang=english';
                
                // Using a CORS proxy to bypass browser restrictions
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(bbcUrl)}`;

                try {
                    const response = await fetch(proxyUrl);
                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }
                    const data = await response.json();
                    
                    let articlesArray = null;

                    if (Array.isArray(data)) {
                        articlesArray = data; // Handles cases where the API returns a direct array
                    } else if (data && data.Latest && Array.isArray(data.Latest)) {
                        articlesArray = data.Latest; // Handles the object format for 'latest'
                    } else if (data && data.News && Array.isArray(data.News)) {
                        articlesArray = data.News; // Handles a potential object format for 'news'
                    }

                    if (articlesArray === null) {
                        console.error("API response is not in a recognized array format:", data);
                        throw new Error("Invalid data format from news API.");
                    }

                    return articlesArray.map(item => ({
                        title: item.title,
                        summary: item.description 
                    }));
                } catch (error) {
                    console.error(`Attempt failed: ${error.message}`);
                    if (retries > 0) {
                        console.log(`Retrying... (${retries} attempts left)`);
                        await new Promise(res => setTimeout(res, delay));
                        return fetchBbcNews(category, retries - 1, delay * 2);
                    } else {
                        console.error("All retries failed for fetching BBC news.");
                        throw error;
                    }
                }
            }

            const updateActiveLink = (category) => {
                navLinks.forEach(link => {
                    link.classList.toggle('active', link.dataset.category === category);
                });
            };

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const category = e.target.dataset.category;
                    currentCategory = category;
                    updateActiveLink(category);
                    fetchNews(category);
                });
            });

            // --- Chatbot Logic with Firestore ---
            function setupChatListener() {
                if (!isAuthReady || !db) return;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const chatCollectionPath = `artifacts/${appId}/users/${userId}/chats`;
                const q = query(collection(db, chatCollectionPath));
                
                onSnapshot(q, (snapshot) => {
                    const messages = [];
                    snapshot.forEach(doc => messages.push({ id: doc.id, ...doc.data() }));
                    messages.sort((a,b) => a.timestamp?.toMillis() - b.timestamp?.toMillis());
                    renderMessages(messages);
                });
            }

            function renderMessages(messages) {
                chatMessages.innerHTML = '';
                 if (messages.length === 0) {
                    const welcome = document.createElement('div');
                    welcome.className = 'chat-message bot-message';
                    welcome.textContent = 'Hello! Ask me anything about the current news headlines.';
                    chatMessages.appendChild(welcome);
                } else {
                    messages.forEach(msg => addMessageToUI(msg.text, msg.sender));
                }
            }
            
            async function saveMessageToFirestore(text, sender) {
                if (!isAuthReady || !db) return;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const chatCollectionPath = `artifacts/${appId}/users/${userId}/chats`;
                try {
                    await addDoc(collection(db, chatCollectionPath), {
                        text: text,
                        sender: sender,
                        timestamp: serverTimestamp()
                    });
                } catch (error) {
                    console.error("Error writing message to Firestore: ", error);
                }
            }
            
            function addMessageToUI(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${sender}-message`;
                messageDiv.textContent = text;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            async function handleSendMessage() {
                const query = chatInput.value.trim();
                if (!query) return;

                chatInput.value = '';
                await saveMessageToFirestore(query, 'user');

                try {
                    const response = await callChatbotAPI(query);
                    await saveMessageToFirestore(response, 'bot');
                } catch (error) {
                    console.error("Error with chatbot API:", error);
                    await saveMessageToFirestore("Sorry, I'm having trouble connecting. Please try again.", 'bot');
                }
            }

            async function callChatbotAPI(userQuery) {
                const newsContext = currentNewsHeadlines.join('\n- ');
                const systemPrompt = `You are a helpful and concise news assistant. Use your real-time search capabilities to answer user questions about the provided news headlines.
                
                CURRENT NEWS HEADLINES:
                - ${newsContext}`;
                
                const fullPrompt = `${systemPrompt}\n\nUSER QUERY: ${userQuery}`;

                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ parts: [{ text: fullPrompt }] }],
                    tools: [{ "google_search": {} }],
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "I couldn't find an answer for that.";
            }

            // --- Event Listeners ---
            chatbotToggle.addEventListener('click', () => {
                const isHidden = chatbotWindow.classList.contains('hidden');
                if(isHidden) {
                    chatbotWindow.classList.remove('hidden');
                    setTimeout(() => chatbotWindow.classList.remove('scale-0', 'opacity-0'), 10);
                }
            });
            closeChatbot.addEventListener('click', () => {
                chatbotWindow.classList.add('scale-0', 'opacity-0');
                setTimeout(() => chatbotWindow.classList.add('hidden'), 300);
            });
            chatSend.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') handleSendMessage();
            });

            // --- Initial Load ---
            async function main() {
                await initFirebase();
                fetchNews('national');
            }

            main();
        });
    </script>
</body>
</html>

